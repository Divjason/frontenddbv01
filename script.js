// ì¹´í…Œê³ ë¦¬ë³„ ì œí’ˆ ë°ì´í„°
window.productsByCategory = {
  "ìŠ¤í‚¨ / í† ë„ˆ": [
    {
      id: 1,
      name: "ì—ìŠ¤ë„¤ì´ì²˜ - ì•„ì¿ ì•„ ì˜¤ì•„ì‹œìŠ¤ í† ë„ˆ 300ml",
      desc: "ë”ë¸” ê¸°íš (í† ë„ˆ + í† ë„ˆ + í™”ì¥ì†œ)",
      image: "./Rectangle 9.png",
      thumbnail: "./Rectangle 9.png",
      reviewImage: "./Vector.png", // ë¦¬ë·° ì¹´ë“œ ì´ë¯¸ì§€ (ê° ì œí’ˆë³„ë¡œ ìˆ˜ì • ê°€ëŠ¥)
      starImage: "./star.png", // ë³„ ì´ë¯¸ì§€ (ê° ì œí’ˆë³„ë¡œ ìˆ˜ì • ê°€ëŠ¥)
      discount: "63%",
      price: "19,500ì›",
      reviews: [
        {
          text: "ë‚´ í”¼ë¶€ : ì†ê±´ì¡° + ìˆ˜ë¶€ì§€ + ë³µí•©ì„±í”¼ë¶€ ë‹¦í† ë“  í¡í† ë“  ìˆ˜ë¶„ ì°¨ì˜¤ë¦„! ì´ê±´ ì§„ì • + í”¼ì§€ì¡°ì ˆ + í¡ìˆ˜ ë¯¸ì¹¨! í”¼ë¶€ ì«€ë“í•¨",
          date: "2023.02.15",
          user: "ì†”ì§ë¦¬ë·°í€¸_ìœ¼ì•„ì´",
          rating: 5,
        },
        {
          text: "í¡í† ë¥¼ í•  ìˆ˜ë¡ í”¼ë¶€ ì°¹ìŒ€ë–¡ ë©ë‹ˆë‹¤ ê·¸ëƒ¥ ë¯¼ê°ì„± ìˆ˜ë¶€ì§€ì— ì„±ë¶„ ì˜ˆë¯¼ í”¼ë¶€ì¸ë°ë„ íŠ¸ëŸ¬ë¸”ì´ë‚˜ ìê·¹ ì „í˜€ ì—†ìŒ",
          date: "2023.09.14",
          user: "jian*3319",
          rating: 5,
        },
        {
          text: "ì˜ˆë¯¼ë³´ìŠ¤ì˜ í† ë„ˆ ì •ì°©í…œ í¡í† ë„ ì¢‹ì§€ë§Œ ê°œì¸ì ìœ¼ë¡œëŠ” ë‹¦í† ë¡œ ì• ìš©ì¤‘",
          date: "2022.10.31",
          user: "ì¨”ì¨”ì¨”",
          rating: 5,
        },
      ],
    },
    {
      id: 2,
      name: "í† ë‹ˆëª¨ë¦¬ - ì›ë” ì„¸ë¼ë§ˆì´ë“œ ëª¨ì°Œ í† ë„ˆ",
      desc: "ì›ë” ì„¸ë¼ë§ˆì´ë“œ ëª¨ì°Œ í† ë„ˆ 500ml",
      image: "./Rectangle 9-1.png",
      thumbnail: "./Rectangle 9-1.png",
      reviewImage: "./Vector.png",
      starImage: "./star.png",
      discount: "45%",
      price: "15,000ì›",
      reviews: [
        {
          text: "ì—¬ë¦„ì— ë‹µë‹µí•´ì„œ ì´ê²ƒ ì €ê²ƒ ëª» ë°”ë¥´ê² ëŠ”ë° ì´ê±° í•˜ë‚˜ë§Œ ë°œë¼ì„œ í¡ìˆ˜ì‹œí‚¤ê³  ë‚˜ê°€ë©´ ìˆ˜ë¶„ê°ì€ ìˆê³  ë‹µë‹µí•˜ì§€ ì•Šì•„ì„œ ë„ˆë¬´ ì¢‹ì•„ìš”!!",
          date: "2025.07.21",
          user: "êµ°ê³ êµ¬ë§ˆë‚¸ë†”",
          rating: 5,
        },
        {
          text: "ì¬êµ¬ë§¤í…œ + ì¸ìƒ í¡ìˆ˜ í† ë„ˆ 1ìœ„ í”¼ë¶€ ì¥ë³€ ì§€ì¼œì£¼ëŠ” ì«€ì«€ í† ë„ˆ",
          date: "2025.05.31",
          user: "íƒ€íƒ€ë‹ˆ",
          rating: 4,
        },
        {
          text: "ìœ ëª…í…œì€ ì´ìœ ê°€ ìˆì–´ìš” ì—­ì‹œ!! íŠ¸ëŸ¬ë¸” ì˜ ë‚˜ëŠ” ë³µí•©ì„± í”¼ë¶€ì¸ë° ì–˜ê°€ ì†ë³´ìŠµ ì±„ì›Œì¤˜ì„œ ë¬´ê±°ìš´ê±° ì•ˆë°œë¼ë„ ë¼ìš” ã… ã… ã… ã… ë„˜ì¢‹ì•„",
          date: "2024.02.23",
          user: "ëœ¨ì•„ì”¨",
          rating: 5,
        },
      ],
    },
    {
      id: 3,
      name: "ë¼ìš´ë“œë© - 1025 ë…ë„ í† ë„ˆ",
      desc: "1025 ë…ë„ í† ë„ˆ 500ml",
      image: "./Rectangle 9-2.png",
      thumbnail: "./Rectangle 9-2.png",
      reviewImage: "./Vector.png",
      starImage: "./star.png",
      discount: "35%",
      price: "12,000ì›",
      reviews: [
        {
          text: "ìš©ëŸ‰ì´ í¬ê³  ìˆœí•œ í† ë„ˆì…ë‹ˆë‹¤! í‰ì†Œì—ë„ ë¶€ë‹´ ì—†ì´ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì„œ ì¢‹ì•„ìš” ã…ã…",
          date: "2020.03.22",
          user: "gargar",
          rating: 5,
        },
        {
          text: "ê°ì§ˆì œê±° í”¼ë¶€ì— ì•ˆì¢‹ë‹¤ëŠ” ì–˜ê¸° ë“¤ì–´ì„œ ì•ˆí•˜ëŠ”ë° ìš”ì²  98% ì‚¬ë¼ì¡Œì–´ìš” ã…ã…Š...",
          date: "2020.01.09",
          user: "ì•„ì‹œì•ˆì´ì‹œì•ˆ",
          rating: 4,
        },
        {
          text: "7ë…„ ë„˜ê²Œ ì“°ê³ ìˆëŠ” ì¸ìƒí…œâ¤ï¸ ì—¬ë“œë¦„ í­íƒ„ ì‹œì ˆë¶€í„° ì£¼ì‚¬í”¼ë¶€ì—¼ìœ¼ë¡œ ê³ ìƒí•˜ë˜ ë•Œ ê·¸ë¦¬ê³  ì§€ê¸ˆê¹Œì§€ ëŠ˜ ê³ì„ ì§€ì¼œì¤€ ê³ ë§ˆìš´ ì¹œêµ¬â˜ºï¸",
          date: "2025.10.13",
          user: "ëŒ•ëŒ•222",
          rating: 5,
        },
      ],
    },
  ],
  "ë¡œì…˜ / ì—ë©€ì „": [
    {
      id: 4,
      name: "ì—ìŠ¤íŠ¸ë¼ - ì•„í† ë² ë¦¬ì–´365 í¬ë¦¼",
      desc: "[1+1][onlyí™”í•´] ì•„í† ë² ë¦¬ì–´365 í¬ë¦¼ 80mlê¸°íš(ë³¸í’ˆ+ì—ì„¼ìŠ¤ 25ml+ìƒ¤ì‰6ë§¤)",
      image: "./Rectangle 9-3.png",
      thumbnail: "./Rectangle 9-3.png",
      reviewImage: "./Vector.png",
      starImage: "./star.png",
      discount: "25%",
      price: "49,500ì›",
      reviews: [
        {
          text: "ë°”ë¥´ìë§ˆì ì†ê¹Œì§€ ì´‰ì´‰í•´ì§€ê³  í”¼ë¶€ê°€ í¸ì•ˆí•´ìš” ì—¬ë¦„ì—ëŠ” ë¦¬ì¹˜í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì§€ì„±í”¼ë¶€ëŠ” ì–‘ ì¡°ì ˆ í•„ìˆ˜ì…ë‹ˆë‹¤!",
          date: "2025.06.12",
          user: "ìœ ì•¤ë¯¸ì• ë‚˜",
          rating: 5,
        },
        {
          text: "í”¼ë¶€ì¥ë²½ íšŒë³µì— íš¨ê³¼ ì¢‹ë‹¤í•´ì„œ ë°”ë¡œ êµ¬ë§¤í–ˆì–´ìš” ë°œë¦¼ì„±ì´ ì§„ì§œ ì¢‹ê³  ì €ëŠ” ì‹¬ì§€ì–´ êµ¬ìˆœì—¼ì—ë„ ë°œë¼ë´¤ëŠ”ë° êµ¬ìˆœì—¼ë„ 3ì¼ë§Œì— ë‚˜ì•˜ì–´ìš”!!",
          date: "2025.03.06",
          user: "thebest",
          rating: 5,
        },
        {
          text: "ì—ìŠ¤íŠ¸ë¼ ë¼ì¸ 2ë…„ ë„˜ê²Œ ì‚¬ìš©ì¤‘ì¸ë° ë„ˆì–´ì–´ì–´ì–´ë¬´ ì¢‹ì•„ìš”!! ìˆœí•˜ê³  ë°œë¦¼ì„±ì— ë³´ìŠµê¹Œì§€ ìµœê³ ì—ìš”!!!",
          date: "2025.09.02",
          user: "ë¼ì´ìš”",
          rating: 4,
        },
      ],
    },
    {
      id: 5,
      name: "ë¹„í”Œë ˆì¸ - ë…¹ë‘ ëª¨ê³µ íƒ€ì´íŠ¸ì—… ìˆ˜ë”© í¬ë¦¼",
      desc: "[onlyí™”í•´] ë…¹ë‘ ëª¨ê³µ íƒ€ì´íŠ¸ì—… ìˆ˜ë”© í¬ë¦¼ 60ml+20ml ê¸°íš (+ë…¹ë‘í¼ 20ml)",
      image: "./Rectangle 9-4.png",
      thumbnail: "./Rectangle 9-4.png",
      reviewImage: "./Vector.png",
      starImage: "./star.png",
      discount: "40%",
      price: "18,000ì›",
      reviews: [
        {
          text: "í¬ë¦¼ë°”ë¥´ëŠ” ìˆœê°„ ì–¼êµ´ ì‹œì›í•´ì ¸ì„œ ì™„ì „ ì¢‹ì•„ìš”!!! ì—´ê°ì´ í™• ë‚´ë ¤ê°‘ë‹ˆë‹¤ â˜ºï¸",
          date: "2025.05.26",
          user: "ì˜¤ëŠ˜ë„ê¹¡ì´",
          rating: 5,
        },
        {
          text: "ë°”ë¥´ìë§ˆì ì¿¨ë§ê°ì´ ëŠê»´ì ¸ì„œ ë”ìš´ ë‚ ì”¨ì— ì‚¬ìš©í•˜ê¸° ë”± ì¢‹ì•„ìš”!!",
          date: "2025.07.09",
          user: "ë´„ì›œë‚˜",
          rating: 5,
        },
        {
          text: "í”¼ë¶€ ì˜ˆë¯¼í•´ì„œ íŠ¸ëŸ¬ë¸” ë‚ ê¹Œ ê±±ì •í–ˆëŠ”ë° ì´ ì œí’ˆì€ ê·¸ëŸ° ê±±ì • ì‹¹ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤! ë°œë¦¼ì„±ë„ ì¢‹ê³  ë§ˆë¬´ë¦¬ê° ì‚°ëœ»í•´ì„œ ì˜ ì“°ê³ ìˆì–´ìš”!",
          date: "2025.04.19",
          user: "ë„¤ë„´ë„¹ë„µë„·",
          rating: 4,
        },
      ],
    },
    {
      id: 6,
      name: "ì—ìŠ¤ë„¤ì´ì²˜ - ì•„ì¿ ì•„ ìŠ¤ì¿ ì•Œë€ ìˆ˜ë¶„í¬ë¦¼",
      desc: "ì•„ì¿ ì•„ ìŠ¤ì¿ ì•Œë€ ìˆ˜ë¶„í¬ë¦¼ 80ml ë”ë¸”+ì„¸ëŸ¼ 10ml ì„¸íŠ¸",
      image: "./Rectangle 9-5.png",
      thumbnail: "./Rectangle 9-5.png",
      reviewImage: "./Vector.png",
      starImage: "./star.png",
      discount: "30%",
      price: "16,000ì›",
      reviews: [
        {
          text: "2ë…„ì§¸ ì“°ëŠ” ì¤‘ì¸ë° ì˜ˆë¯¼í•œ ì œ í”¼ë¶€ì— ì™„ì „ ë”± ë§ì•„ìš”! ì´‰ì´‰í•˜ê³  ìˆ˜ë¶„ ê°€ë“í•©ë‹ˆë‹¤!!!",
          date: "2025.05.11",
          user: "gggqqg",
          rating: 5,
        },
        {
          text: "ë‚´ëˆ ë‚´ì‚° í›„ê¸° : íŠ¸ëŸ¬ë¸” ì˜ ë‚˜ëŠ” í¸ì¸ë° ìœ ë¶„ê° í•˜ë‚˜ë„ ì—†ê³  ìˆ˜ë¶„ ê°€ë“í•œ ëŠë‚Œìœ¼ë¡œ ì´‰ì´‰í•©ë‹ˆë‹¤. ë°”ë¥´ê³  ë‚˜ì„œë„ íŠ¸ëŸ¬ë¸” í•˜ë‚˜ë„ ì•ˆë‚˜ê³  ì•„ì¹¨ì— ì¼ì–´ë‚˜ë„ ì´‰ì´‰í•´ìš”!",
          date: "2020.03.19",
          user: "ë©”ë¡ ì´ë©”ë¡±",
          rating: 5,
        },
        {
          text: "ì˜¤ì¼ ë“¤ì–´ê°„ê±°ì— íŠ¸ëŸ¬ë¸”ì´ ë§ì´ë‚˜ì„œ ì¡°ì‹¬í•´ì„œ ì“°ëŠ”ë° ì–˜ëŠ” íŠ¸ëŸ¬ë¸”ë„ ì•ˆë‚˜ê³  ë‹¤ë¥¸ ì œí’ˆìœ¼ë¡œ ë„˜ì–´ê°”ë‹¤ê°€ ë‹¤ì‹œ ëŒì•„ì™”ìŠµë‹ˆë‹¤! ì–˜ê°€ ì§±ì¸ë“¯í•´ìš”!!",
          date: "2024.04.22",
          user: "ì½”ë•í™”ë•",
          rating: 5,
        },
      ],
    },
  ],
  "ì„¸ëŸ¼ / ì—ì„¼ìŠ¤": [
    {
      id: 7,
      name: "í† ë¦¬ë“  - ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° ì„¸ëŸ¼",
      desc: "[onlyí™”í•´] ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° ì„¸ëŸ¼ 100ml ê¸°íš (+ìˆ˜ë”©í¬ë¦¼ 50ml)",
      image: "./Rectangle 9-6.png",
      thumbnail: "./Rectangle 9-6.png",
      reviewImage: "./Vector.png",
      starImage: "./star.png",
      discount: "38%",
      price: "27,000ì›",
      reviews: [
        {
          text: "ë³´ìŠµë ¥ ìµœê³ ! ì°ë•ê±°ë¦¼ ì—†ê³  ê¸°ë¶„ ì¢‹ì€ ë§ˆë¬´ë¦¬ê°ì„! ì§€ê¸ˆë³´ë‹¤ í° ì§ìŠ¹ìš©ëŸ‰ì´ í•„ìš”í•©ë‹ˆë‹¤!!",
          date: "2025.03.11",
          user: "ë©•í‚·ìŠ¤í‚¨êµ¿",
          rating: 5,
        },
        {
          text: "ì´‰ì´‰í•˜ê¸´ í•œë° ê·¹ ê±´ì„±ë“¤ì€ í˜ì´ìŠ¤ ì˜¤ì¼ í•œ ë‘ë°©ìš¸ ì„ì–´ì„œ ì‚¬ìš©í•˜ëŠ” ê±° ì¶”ì²œ!!",
          date: "2022.05.16",
          user: "ë‚˜ë‹¤ì´",
          rating: 5,
        },
        {
          text: "ê²°ë¡  : ì†ê±´ì¡° ì¡ëŠ”ê±° ìµœê³ ! ì„±ë¶„, ê°€ì„±ë¹„ ìµœê³ ê³  ì—¬ëŸ¬ë²ˆ ë ˆì´ì–´ë§í•  ìˆ˜ë¡ ì¢‹ìŒ!",
          date: "2023.11.29",
          user: "ì˜¤ë‹ˆê°€ë¼ë¼",
          rating: 4,
        },
      ],
    },
    {
      id: 8,
      name: "ì›°ë¼ì¥¬ - ë¦¬ì–¼ íˆì•Œë£¨ë¡œë‹‰ ë¸”ë£¨ 100 ì•°í”Œ",
      desc: "[onlyí™”í•´] ë¦¬ì–¼ íˆì•Œë£¨ë¡œë‹‰ ë¸”ë£¨ 100 ì•°í”Œ 120mlê¸°íš(ë³¸í’ˆ60ml+ë¦¬í•„60ml)",
      image: "./Rectangle 9-7.png",
      thumbnail: "./Rectangle 9-7.png",
      reviewImage: "./Vector.png",
      starImage: "./star.png",
      discount: "35%",
      price: "28,000ì›",
      reviews: [
        {
          text: "ì €ëŠ” ì§€ë³µí•©ì„±&ì˜ˆë¯¼ í”¼ë¶€ì…ë‹ˆë‹¤ ì†ë‹¹ê¹€ í™•ì‹¤íˆ ì¤„ì–´ë“œëŠ” ìˆœí•œ ë³´ìŠµì•°í”Œë¡œ ì™„ì „ ì¶”ì²œí•´ìš”!",
          date: "2025.06.01",
          user: "ë‚˜ë‚˜ì˜ëŒ€í™•í–‰",
          rating: 5,
        },
        {
          text: "íŠ¸ëŸ¬ë¸” ì•ˆë‚¨, ë°œë¦¼ì„± êµ¿ğŸ‘ ìˆ˜ë¶„+ë³´ìŠµ+íƒ±íƒ±ì˜ íƒ„ë ¥!! ì†ê±´ì¡°, ì†ë³´ìŠµ ì§„ì‹¬ ë‹¤ ì¡ìŒ",
          date: "2024.01.24",
          user: "ë‚´ê°€ë°”ë¡œë¦¬ë·°ì™•",
          rating: 5,
        },
        {
          text: "ì™„ì „ ë¯¼ê°í•˜ë‹¤ë©´ ë¹„ì¶” ê·¸ëŸ¬ë‚˜ ë³µí•©ì„±, ìˆ˜ë¶€ì§€ ê°•ë ¥ì¶”ì²œ ë³´ìŠµ ì•°í”ŒğŸ‘ğŸ‘",
          date: "2023.12.22",
          user: "ë¿…ë¿…ë¹µë¹µ",
          rating: 4,
        },
      ],
    },
    {
      id: 9,
      name: "ì•„ëˆ„ì•„ - PDRN íˆì•Œë£¨ë¡ ì‚° ìº¡ìŠ 100 ì„¸ëŸ¼",
      desc: "[onlyí™”í•´] í”¼ë””ì•Œì—” ìº¡ìŠ100 ì„¸ëŸ¼ 50ml ëŒ€ìš©ëŸ‰ ê¸°íš(+í¬ë¦¼10ml+ì‚¬ì…° 6ë§¤)",
      image: "./Rectangle 9-8.png",
      thumbnail: "./Rectangle 9-8.png",
      reviewImage: "./Vector.png",
      starImage: "./star.png",
      discount: "40%",
      price: "24,000ì›",
      reviews: [
        {
          text: "ì´ˆì´ˆì´ˆë¯¼ê°ì„± í”¼ë¶€ PDRN ì²« ë„ì „!! = íŠ¸ëŸ¬ë¸” ì œë¡œ ë°”ë¥´ê¸° ì „í›„ ì°¨ì´ê°€ ì§„ì§œ í¬ê³  ë¬´ì¡°ê±´ ì¶”ì²œ!! ì†ë³´ìŠµ ìœ ì§€ë ¥ë„ ìœ ì§€ë ¥ì´ì§€ë§Œ ì–¼êµ´ì— ê´‘ì±„ê°€ ë•ë‹ˆë‹¤!!!",
          date: "2024.11.05",
          user: "ì½”ê¸°ë¹µëŒ•ì£ ì•„",
          rating: 5,
        },
        {
          text: "ê´‘ê³ ë³´ê³  êµ¬ë§¤í–ˆëŠ”ë° ìê·¹ ì—†ê³  íœ´ëŒ€ìš© ì‚¬ì´ì¦ˆê°€ ë§˜ì— ë“¤ì–´ì„œ ìƒ€ì–´ìš”! ë ˆì´ì–´ë§ í•˜ë‹ˆê¹Œ ì«€ì«€í•´ìš”!",
          date: "2025.06.29",
          user: "ë² ë² 99",
          rating: 4,
        },
        {
          text: "ë ˆì´ì–´ë§í•˜ë‹ˆê¹Œ ì´‰ì´‰í•˜ê³  ì¢‹ì•˜ì–´ìš”! ì«€ë“í•œ ëŠë‚Œì´ë¼ í˜¸ë¶ˆí˜¸ëŠ” ê°ˆë¦´ ìˆ˜ ìˆì„ ê²ƒ ê°™ì§€ë§Œ ì €ëŠ” ì¢‹ì•˜ìŠµë‹ˆë‹¤!!",
          date: "2024.08.12",
          user: "íˆíˆë¹„",
          rating: 5,
        },
      ],
    },
  ],
};

// ê¸°ë³¸ ì œí’ˆ ë°ì´í„° (ìŠ¤í‚¨/í† ë„ˆ)
const productData = productsByCategory["ìŠ¤í‚¨ / í† ë„ˆ"];

// ì œí’ˆë³„ í•˜íŠ¸ ìƒíƒœ ì €ì¥ (ì „ì—­)
window.heartStates = {};

// í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ì œí’ˆ ë°ì´í„° ì €ì¥ (ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸)
window.currentProductData = productData;

document.addEventListener("DOMContentLoaded", function () {
  // Fade-up animation trigger for index.html hero components
  const fadeUps = document.querySelectorAll(".fade-up");
  if (fadeUps.length) {
    const io = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("is-in");
            io.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.2 }
    );
    fadeUps.forEach((el) => io.observe(el));
  }

  // ë„¤ë¹„ê²Œì´ì…˜ ë§í¬
  const navLinks = document.querySelectorAll(".nav-link");
  navLinks.forEach((link) => {
    link.addEventListener("click", function (e) {
      e.preventDefault();
      navLinks.forEach((l) => l.classList.remove("active"));
      this.classList.add("active");
    });
  });

  // í”¼ë¶€íƒ€ì… íƒ­
  const skinTypeTabs = document.querySelectorAll(".skin-type-tab");
  skinTypeTabs.forEach((tab) => {
    tab.addEventListener("click", function () {
      skinTypeTabs.forEach((t) => t.classList.remove("active"));
      this.classList.add("active");
    });
  });

  // ì–¸ì–´ ë²„íŠ¼
  const langButton = document.querySelector(".lang-button");
  if (langButton) {
    langButton.addEventListener("click", function (e) {
      e.preventDefault();
      // ì–¸ì–´ ë³€ê²½ ë¡œì§
    });
  }

  // ê²€ìƒ‰ ì…ë ¥
  const searchLink = document.querySelector(".search-link");
  if (searchLink) {
    searchLink.addEventListener("click", function (e) {
      e.preventDefault();
      // ê²€ìƒ‰ í˜ì´ì§€ë¡œ ì´ë™
    });
  }

  // ì œí’ˆ ì„ íƒ ê¸°ëŠ¥
  const productItems = document.querySelectorAll(".product-item");
  const selectedProductImage = document.querySelector(
    ".selected-product-image img"
  );
  const selectedProductName = document.querySelectorAll(
    ".selected-product-name div"
  );
  const selectedProductPrice = document.querySelector(
    ".selected-product-price"
  );
  const reviewsGrid = document.querySelector(".reviews-grid");
  const heartBtn = document.querySelector(".heart-btn");

  productItems.forEach((item, index) => {
    item.addEventListener("click", function () {
      // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
      productItems.forEach((p) => p.classList.remove("selected"));
      item.classList.add("selected");

      // ì œí’ˆ ì •ë³´ ì—…ë°ì´íŠ¸ (ì¹´í…Œê³ ë¦¬ ë³€ê²½ í›„ì—ëŠ” window.currentProductData ì‚¬ìš©)
      const currentData = window.currentProductData || productData;
      const product = currentData[index];
      if (product) {
        // ì´ë¯¸ì§€ ë³€ê²½
        if (selectedProductImage) {
          selectedProductImage.src = product.image;
        }

        // ì´ë¦„ ë° ì„¤ëª… ë³€ê²½
        if (selectedProductName.length >= 2) {
          selectedProductName[0].textContent = product.name;
          selectedProductName[1].textContent = product.desc;
        }

        // ê°€ê²© ë³€ê²½
        if (selectedProductPrice) {
          selectedProductPrice.innerHTML = `<span class="price-discount">${product.discount}</span> <span> ${product.price}</span>`;
        }

        // ë¦¬ë·° ë³€ê²½
        if (reviewsGrid && product.reviews) {
          reviewsGrid.innerHTML = "";
          product.reviews.forEach((review) => {
            const reviewCard = document.createElement("div");
            reviewCard.className = "review-card";
            reviewCard.innerHTML = `
                            <img src="${
                              product.reviewImage || "./Vector.png"
                            }" alt="ë²¡í„°" class="Vector" style="width:18px; height:18px;">
                            <div class="review-text">${review.text}</div>
                            <div class="review-meta">
                                <img src="${
                                  product.starImage || "./star.png"
                                }" alt="">
                                <span>${review.date}</span>
                                <span>|</span>
                                <span>${review.user}</span>
                            </div>
                        `;
            reviewsGrid.appendChild(reviewCard);
          });
        }

        // ì œí’ˆë³„ í•˜íŠ¸ ìƒíƒœ ë³µì›
        if (heartBtn) {
          if (window.heartStates[product.id] === true) {
            heartBtn.classList.add("active");
            const img = heartBtn.querySelector("img");
            if (img) {
              img.src = "./heart_color.png";
              img.alt = "ì±„ì›Œì§„ í•˜íŠ¸";
            }
          } else {
            heartBtn.classList.remove("active");
            const img = heartBtn.querySelector("img");
            if (img) {
              img.src = "./heart.png";
              img.alt = "í•˜íŠ¸";
            }
          }
        }
      }
    });
  });

  // ì¹´í…Œê³ ë¦¬ í† ê¸€ ë“œë¡­ë‹¤ìš´
  const categorySelector = document.querySelector(".category-selector");
  const categoryDropdown = document.querySelector(".category-dropdown");
  const categoryText = document.querySelector(".category-text");
  const categoryArrow = document.querySelector(".category-arrow");
  const categoryOptions = document.querySelectorAll(".category-option");

  if (categorySelector && categoryDropdown) {
    let isOpen = false;

    categorySelector.addEventListener("click", function (e) {
      e.stopPropagation();
      isOpen = !isOpen;
      categoryDropdown.classList.toggle("open", isOpen);
      if (categoryArrow) {
        categoryArrow.style.transform = isOpen
          ? "rotate(180deg)"
          : "rotate(0deg)";
        categoryArrow.style.transition = "transform 0.2s";
      }
    });

    // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì„ íƒ
    categoryOptions.forEach((option) => {
      option.addEventListener("click", function (e) {
        e.stopPropagation();
        const selectedCategory = this.getAttribute("data-category");
        if (!selectedCategory) return;

        // ëª¨ë“  ì˜µì…˜ì—ì„œ selected ì œê±°
        categoryOptions.forEach((opt) => opt.classList.remove("selected"));

        // ì„ íƒí•œ ì˜µì…˜ì— selected ì¶”ê°€
        this.classList.add("selected");

        // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        if (categoryText) {
          categoryText.textContent = selectedCategory;
        }

        // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        isOpen = false;
        categoryDropdown.classList.remove("open");
        if (categoryArrow) {
          categoryArrow.style.transform = "rotate(0deg)";
        }

        // ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” ì œí’ˆ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
        const newProducts = window.productsByCategory[selectedCategory] || [];
        if (newProducts.length > 0) {
          // ì „ì—­ productData ì—…ë°ì´íŠ¸ (toggleHeart í•¨ìˆ˜ì—ì„œ ì‚¬ìš©)
          if (typeof productData !== "undefined") {
            // productDataëŠ” constì´ë¯€ë¡œ ì§ì ‘ ì¬í• ë‹¹í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ,
            // window ê°ì²´ì— ì €ì¥í•˜ê±°ë‚˜ í•¨ìˆ˜ ë‚´ì—ì„œ ë™ì ìœ¼ë¡œ ì ‘ê·¼í•˜ë„ë¡ ì²˜ë¦¬
            // ëŒ€ì‹  ì „ì—­ ë³€ìˆ˜ë¡œ ê´€ë¦¬
            window.currentProductData = newProducts;
          }

          // ì œí’ˆ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          const productList = document.querySelector(".product-list");
          if (productList) {
            productList.innerHTML = "";
            newProducts.forEach((product, index) => {
              const productItem = document.createElement("div");
              productItem.className =
                "product-item" + (index === 0 ? " selected" : "");
              productItem.innerHTML = `
                                <img src="${product.thumbnail}" alt="">
                                <div class="product-info">
                                    <div>${product.name}</div>
                                    <div>${product.desc}</div>
                                </div>
                            `;
              productList.appendChild(productItem);
            });

            // ì²« ë²ˆì§¸ ì œí’ˆì„ ì„ íƒëœ ìƒíƒœë¡œ ì„¤ì •í•˜ê³  ì •ë³´ ì—…ë°ì´íŠ¸
            const firstProduct = newProducts[0];
            updateProductInfo(firstProduct);
            updateReviews(firstProduct.reviews, firstProduct);
            updateHeartState(firstProduct);

            // ì œí’ˆ ì„ íƒ ì´ë²¤íŠ¸ ë‹¤ì‹œ ì—°ê²°
            const newProductItems = document.querySelectorAll(".product-item");
            newProductItems.forEach((item, idx) => {
              item.addEventListener("click", function () {
                newProductItems.forEach((p) => p.classList.remove("selected"));
                item.classList.add("selected");
                const product = newProducts[idx];
                if (product) {
                  updateProductInfo(product);
                  updateReviews(product.reviews, product);
                  updateHeartState(product);
                }
              });
            });
          }
        }
      });
    });

    // ì œí’ˆ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateProductInfo(product) {
      const selectedProductImage = document.querySelector(
        ".selected-product-image img"
      );
      const selectedProductName = document.querySelectorAll(
        ".selected-product-name div"
      );
      const selectedProductPrice = document.querySelector(
        ".selected-product-price"
      );

      if (selectedProductImage) {
        selectedProductImage.src = product.image;
      }

      if (selectedProductName.length >= 2) {
        selectedProductName[0].textContent = product.name;
        selectedProductName[1].textContent = product.desc;
      }

      if (selectedProductPrice) {
        selectedProductPrice.innerHTML = `<span class="price-discount">${product.discount}</span> <span> ${product.price}</span>`;
      }
    }

    // ë¦¬ë·° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateReviews(reviews, product) {
      const reviewsGrid = document.querySelector(".reviews-grid");
      if (reviewsGrid && reviews) {
        reviewsGrid.innerHTML = "";
        reviews.forEach((review) => {
          const reviewCard = document.createElement("div");
          reviewCard.className = "review-card";
          reviewCard.innerHTML = `
                        <img src="${
                          product.reviewImage || "./Vector.png"
                        }" alt="ë²¡í„°" class="Vector" style="width:18px; height:18px;">
                        <div class="review-text">${review.text}</div>
                        <div class="review-meta">
                            <img src="${
                              product.starImage || "./star.png"
                            }" alt="">
                            <span>${review.date}</span>
                            <span>|</span>
                            <span>${review.user}</span>
                        </div>
                    `;
          reviewsGrid.appendChild(reviewCard);
        });
      }
    }

    // í•˜íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateHeartState(product) {
      if (heartBtn) {
        if (window.heartStates[product.id] === true) {
          heartBtn.classList.add("active");
          const img = heartBtn.querySelector("img");
          if (img) {
            img.src = "./heart_color.png";
            img.alt = "ì±„ì›Œì§„ í•˜íŠ¸";
          }
        } else {
          heartBtn.classList.remove("active");
          const img = heartBtn.querySelector("img");
          if (img) {
            img.src = "./heart.png";
            img.alt = "í•˜íŠ¸";
          }
        }
      }
    }

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener("click", function (e) {
      if (categorySelector && categoryDropdown && isOpen) {
        if (
          !categorySelector.contains(e.target) &&
          !categoryDropdown.contains(e.target)
        ) {
          isOpen = false;
          categoryDropdown.classList.remove("open");
          if (categoryArrow) {
            categoryArrow.style.transform = "rotate(0deg)";
          }
        }
      }
    });
  }

  // ì„¤ë¬¸ì¡°ì‚¬ ë¼ë””ì˜¤ ë²„íŠ¼
  const surveyItems = document.querySelectorAll(".survey-item");
  surveyItems.forEach((surveyItem) => {
    const ratingButtons = surveyItem.querySelectorAll(".rating-btn");
    ratingButtons.forEach((button) => {
      button.addEventListener("click", function () {
        // ê°™ì€ ì§ˆë¬¸ì˜ ëª¨ë“  ë²„íŠ¼ì—ì„œ active ì œê±°
        ratingButtons.forEach((btn) => btn.classList.remove("active"));
        // í´ë¦­í•œ ë²„íŠ¼ì— active ì¶”ê°€
        this.classList.add("active");

        // ì„ íƒ ìƒíƒœë¥¼ localStorageì— ì €ì¥
        saveSurveyState(surveyItem, this);
      });
    });
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ë¬¸ì¡°ì‚¬ ì„ íƒ ìƒíƒœ ë³µì›
  restoreSurveyStates();

  // review-card ìë™ ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜
  initReviewCardAutoScroll();
});

// review-card ìë™ ìŠ¤í¬ë¡¤ í•¨ìˆ˜
function initReviewCardAutoScroll() {
  const reviewsGrid = document.querySelector(".reviews-grid");
  if (!reviewsGrid) return;

  const reviewCards = reviewsGrid.querySelectorAll(".review-card");
  if (reviewCards.length <= 1) return;

  // ìë™ ìŠ¤í¬ë¡¤ ì‹œê°„ ê°„ê²© ì„¤ì • (ë°€ë¦¬ì´ˆ) - ì—¬ê¸°ì„œ ì´ˆ ë³€ê²½ ê°€ëŠ¥
  const SCROLL_INTERVAL = 4000; //(ì›í•˜ëŠ” ì´ˆë¡œ ë³€ê²½ ê°€ëŠ¥)

  let currentIndex = 0;
  let autoScrollInterval = null;

  // ì¹´ë“œ ë„ˆë¹„ ê³„ì‚° (ì¹´ë“œ + gap)
  const cardWidth = reviewCards[0].offsetWidth;
  const gap = parseInt(getComputedStyle(reviewsGrid).gap) || 15;
  const totalWidth = cardWidth + gap;

  // ìë™ ìŠ¤í¬ë¡¤ í•¨ìˆ˜
  function scrollToNext() {
    currentIndex = (currentIndex + 1) % reviewCards.length;
    const scrollPosition = currentIndex * totalWidth;

    reviewsGrid.scrollTo({
      left: scrollPosition,
      behavior: "smooth",
    });
  }

  // ìë™ ìŠ¤í¬ë¡¤ ì‹œì‘
  function startAutoScroll() {
    if (autoScrollInterval) {
      clearInterval(autoScrollInterval);
    }
    autoScrollInterval = setInterval(scrollToNext, SCROLL_INTERVAL);
  }

  // ìë™ ìŠ¤í¬ë¡¤ ì¤‘ì§€
  function stopAutoScroll() {
    if (autoScrollInterval) {
      clearInterval(autoScrollInterval);
      autoScrollInterval = null;
    }
  }

  // ì´ˆê¸° ì‹œì‘
  startAutoScroll();

  // ë§ˆìš°ìŠ¤ í˜¸ë²„ ì‹œ ì¼ì‹œì •ì§€
  reviewsGrid.addEventListener("mouseenter", stopAutoScroll);

  // ë§ˆìš°ìŠ¤ ë– ë‚  ë•Œ ë‹¤ì‹œ ì‹œì‘
  reviewsGrid.addEventListener("mouseleave", startAutoScroll);

  // í„°ì¹˜ ì´ë²¤íŠ¸ ì‹œ ì¼ì‹œì •ì§€
  reviewsGrid.addEventListener("touchstart", function () {
    stopAutoScroll();
  });

  reviewsGrid.addEventListener("touchend", function () {
    // í„°ì¹˜ ì¢…ë£Œ í›„ ìë™ ìŠ¤í¬ë¡¤ ì‹œê°„ë§Œí¼ ë’¤ì— ë‹¤ì‹œ ì‹œì‘
    setTimeout(startAutoScroll, SCROLL_INTERVAL);
  });

  // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ì¶”ì í•˜ì—¬ í˜„ì¬ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
  reviewsGrid.addEventListener("scroll", function () {
    const scrollLeft = reviewsGrid.scrollLeft;
    currentIndex = Math.round(scrollLeft / totalWidth);
  });
}

// ì„¤ë¬¸ì¡°ì‚¬ í‰ì  ì„ íƒ í•¨ìˆ˜ (onclickìš©)
function selectRating(button) {
  const surveyItem = button.closest(".survey-item");
  if (surveyItem) {
    const ratingButtons = surveyItem.querySelectorAll(".rating-btn");
    ratingButtons.forEach((btn) => btn.classList.remove("active"));
    button.classList.add("active");

    // ì„ íƒ ìƒíƒœë¥¼ localStorageì— ì €ì¥
    saveSurveyState(surveyItem, button);

    // ì„¤ë¬¸ì¡°ì‚¬ ì™„ë£Œ ìƒíƒœ í™•ì¸ (main.htmlì˜ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”)
    if (typeof checkSurveyCompletion === "function") {
      setTimeout(checkSurveyCompletion, 100);
    }

    // í™œì„±í™” í™•ì¸ì„ ìœ„í•œ ì½˜ì†” ë¡œê·¸ (ë””ë²„ê¹…ìš©)
    console.log("Rating button activated:", button);
  }
}

// ì„¤ë¬¸ì¡°ì‚¬ ì„ íƒ ìƒíƒœë¥¼ localStorageì— ì €ì¥
function saveSurveyState(surveyItem, selectedButton) {
  try {
    // survey-itemì˜ í´ë˜ìŠ¤ì—ì„œ ì§ˆë¬¸ ë²ˆí˜¸ ì°¾ê¸° (survey-item-1, survey-item-2, survey-item-3 ë“±)
    let questionId = null;
    const classList = surveyItem.classList;
    for (let i = 0; i < classList.length; i++) {
      const className = classList[i];
      if (className.startsWith("survey-item-")) {
        questionId = className;
        break;
      }
    }

    if (!questionId) {
      // survey-item-1, survey-item-2 í˜•ì‹ì´ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ ì‚¬ìš©
      const allSurveyItems = document.querySelectorAll(".survey-item");
      const index = Array.from(allSurveyItems).indexOf(surveyItem);
      if (index >= 0) {
        questionId = `survey-item-${index + 1}`;
      }
    }

    if (!questionId) return;

    // ì„ íƒí•œ ë²„íŠ¼ì˜ ë²ˆí˜¸ ì°¾ê¸°
    const numberSpan = selectedButton.querySelector(".number");
    const ratingNumber = numberSpan ? numberSpan.textContent.trim() : null;

    if (ratingNumber) {
      // localStorageì— ì €ì¥: { questionId: ratingNumber }
      const surveyStates = getSurveyStates();
      surveyStates[questionId] = ratingNumber;
      localStorage.setItem("surveyStates", JSON.stringify(surveyStates));
    }
  } catch (e) {
    console.error("ì„¤ë¬¸ì¡°ì‚¬ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:", e);
  }
}

// localStorageì—ì„œ ì„¤ë¬¸ì¡°ì‚¬ ì„ íƒ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
function getSurveyStates() {
  try {
    const stored = localStorage.getItem("surveyStates");
    return stored ? JSON.parse(stored) : {};
  } catch (e) {
    console.error("ì„¤ë¬¸ì¡°ì‚¬ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
    return {};
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ë¬¸ì¡°ì‚¬ ì„ íƒ ìƒíƒœ ë³µì›
function restoreSurveyStates() {
  try {
    const surveyStates = getSurveyStates();
    const surveyItems = document.querySelectorAll(".survey-item");

    surveyItems.forEach((surveyItem) => {
      // survey-itemì˜ í´ë˜ìŠ¤ì—ì„œ ì§ˆë¬¸ ë²ˆí˜¸ ì°¾ê¸°
      let questionId = null;
      const classList = surveyItem.classList;
      for (let i = 0; i < classList.length; i++) {
        const className = classList[i];
        if (className.startsWith("survey-item-")) {
          questionId = className;
          break;
        }
      }

      if (!questionId) {
        // survey-item-1, survey-item-2 í˜•ì‹ì´ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ ì‚¬ìš©
        const allSurveyItems = document.querySelectorAll(".survey-item");
        const index = Array.from(allSurveyItems).indexOf(surveyItem);
        if (index >= 0) {
          questionId = `survey-item-${index + 1}`;
        }
      }

      if (!questionId || !surveyStates[questionId]) return;

      // ì €ì¥ëœ ì„ íƒ ìƒíƒœ ë³µì›
      const savedRating = surveyStates[questionId];
      const ratingButtons = surveyItem.querySelectorAll(".rating-btn");
      ratingButtons.forEach((button) => {
        const numberSpan = button.querySelector(".number");
        if (numberSpan && numberSpan.textContent.trim() === savedRating) {
          // ê°™ì€ ì§ˆë¬¸ì˜ ëª¨ë“  ë²„íŠ¼ì—ì„œ active ì œê±°
          ratingButtons.forEach((btn) => btn.classList.remove("active"));
          // ì €ì¥ëœ ë²„íŠ¼ì— active ì¶”ê°€
          button.classList.add("active");
        }
      });
    });
  } catch (e) {
    console.error("ì„¤ë¬¸ì¡°ì‚¬ ìƒíƒœ ë³µì› ì‹¤íŒ¨:", e);
  }
}

// í•˜íŠ¸ í† ê¸€ í•¨ìˆ˜ (onclickìš©, HTMLì—ì„œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥)
function toggleHeart(btn) {
  const img = btn.querySelector("img");

  // í˜„ì¬ ì„ íƒëœ ì œí’ˆ ì°¾ê¸°
  const productItems = document.querySelectorAll(".product-item");
  let currentProductIndex = -1;
  productItems.forEach((item, index) => {
    if (item.classList.contains("selected")) {
      currentProductIndex = index;
    }
  });

  // ì œí’ˆ ë°ì´í„°ì—ì„œ ID ê°€ì ¸ì˜¤ê¸° (ì¹´í…Œê³ ë¦¬ ë³€ê²½ í›„ì—ë„ ì‘ë™í•˜ë„ë¡)
  let productId = null;
  let currentProductData = null;

  // window.currentProductDataë¥¼ ë¨¼ì € í™•ì¸ (ì¹´í…Œê³ ë¦¬ ë³€ê²½ í›„)
  if (
    window.currentProductData &&
    window.currentProductData[currentProductIndex]
  ) {
    currentProductData = window.currentProductData;
  } else if (
    typeof productData !== "undefined" &&
    productData[currentProductIndex]
  ) {
    // ê¸°ë³¸ productData í™•ì¸
    currentProductData = productData;
  }

  if (currentProductData && currentProductData[currentProductIndex]) {
    productId = currentProductData[currentProductIndex].id;
  } else if (currentProductIndex >= 0) {
    // ì œí’ˆ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ ì‚¬ìš©
    productId = currentProductIndex;
  }

  if (productId === null) {
    console.log("ì œí’ˆ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if (btn.classList.contains("active")) {
    btn.classList.remove("active");
    img.src = "./heart.png";
    img.alt = "í•˜íŠ¸";
    window.heartStates[productId] = false;
  } else {
    btn.classList.add("active");
    img.src = "./heart_color.png";
    img.alt = "ì±„ì›Œì§„ í•˜íŠ¸";
    window.heartStates[productId] = true;
  }
}

/* =========================================================
   [signup_info ì´ì‹] page1-info.htmlì˜ ìˆ˜ì§‘Â·ì „ì†¡ ë¡œì§
   - ì„¸ì…˜ ìƒì„±(/api/session) â†’ /api/profile ì €ì¥ â†’ signup_choice.html ì´ë™
   - ì»¤ìŠ¤í…€ ìƒë…„ì›”ì¼ ë“œë¡­ë‹¤ìš´ â†’ hidden(year/month/day) ë™ê¸°í™”
   - ì„±ë³„ ë²„íŠ¼ â†’ hidden(gender) ë™ê¸°í™”
   ========================================================= */
(function () {
  const API_BASE = (
    localStorage.getItem("API_BASE") || "https://face-capture-api.onrender.com"
  ).replace(/\/+$/, "");

  // --- ì„¸ì…˜ ê´€ë¦¬ (page1-info.htmlì˜ ë™ì‘ì„ ë™ì¼ ì¬í˜„) ---
  function getSessionId() {
    let sid = localStorage.getItem("faceapp_session");
    if (!sid) {
      sid =
        typeof crypto !== "undefined" && crypto.randomUUID
          ? crypto.randomUUID()
          : String(Date.now()) + Math.random().toString(16).slice(2);
      localStorage.setItem("faceapp_session", sid);
      // ì„œë²„ì—ë„ ë“±ë¡ (ì‹¤íŒ¨í•´ë„ ì§„í–‰)
      const fd = new FormData();
      fd.append("session_id", sid);
      fetch(`${API_BASE}/api/session`, { method: "POST", body: fd }).catch(
        () => {}
      );
    }
    return sid;
  }

  function startNewSession() {
    // ì´ì „ ì„¸ì…˜ ë° í”„ë¡œí•„ ìºì‹œ ì œê±° í›„ ìƒˆ sid ë°œê¸‰
    localStorage.removeItem("faceapp_session");
    localStorage.removeItem("faceapp_profile");
    getSessionId();
  }

  // --- ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ ì¡°ë¦½: hidden(year/month/day) ë™ê¸°í™” ---
  function initBirthDropdowns(form) {
    const yearBox = form.querySelector("#year-dropdown");
    const monthBox = form.querySelector("#month-dropdown");
    const dayBox = form.querySelector("#day-dropdown");

    const yearLabel = form.querySelector(
      ".date-input:not(.month):not(.day) .date-value"
    );
    const monthLabel = form.querySelector(".date-input.month .date-value");
    const dayLabel = form.querySelector(".date-input.day .date-value");

    const hiddenYear = form.querySelector("#birth_year");
    const hiddenMonth = form.querySelector("#birth_month");
    const hiddenDay = form.querySelector("#birth_day");

    if (
      !yearBox ||
      !monthBox ||
      !dayBox ||
      !hiddenYear ||
      !hiddenMonth ||
      !hiddenDay
    )
      return;

    function daysIn(y, m) {
      return new Date(y, m, 0).getDate();
    }
    function fill(box, arr, onPick) {
      box.innerHTML = "";
      arr.forEach((v) => {
        const el = document.createElement("div");
        el.className = "date-option";
        el.textContent =
          (typeof v === "number" ? v : String(v)) +
          (box === yearBox ? "ë…„" : box === monthBox ? "ì›”" : "ì¼");
        el.addEventListener("click", () => onPick(v));
        box.appendChild(el);
      });
    }

    // ì™¸ë¶€ì—ì„œ í˜¸ì¶œë˜ëŠ” í† ê¸€ í•¸ë“¤ëŸ¬ (HTMLì— ê·¸ëŒ€ë¡œ ìœ ì§€ëœ onclickê³¼ í˜¸í™˜)
    window.toggleDropdown = function (wrapper, type) {
      const dd = wrapper.nextElementSibling;
      const willOpen = !dd.classList.contains("open");
      document
        .querySelectorAll(".date-dropdown.open")
        .forEach((x) => x.classList.remove("open"));
      if (!willOpen) return;
      dd.classList.add("open");

      if (type === "year" && !yearBox.children.length) {
        const now = new Date(),
          thisYear = now.getFullYear();
        const years = Array.from(
          { length: thisYear - 1940 + 1 },
          (_, i) => thisYear - i
        );
        fill(yearBox, years, pickYear);
      }
      if (type === "month" && !monthBox.children.length) {
        fill(
          monthBox,
          Array.from({ length: 12 }, (_, i) => i + 1),
          pickMonth
        );
      }
      if (type === "day") {
        const y = Number(hiddenYear.value) || new Date().getFullYear();
        const m = Number(hiddenMonth.value) || new Date().getMonth() + 1;
        fill(
          dayBox,
          Array.from({ length: daysIn(y, m) }, (_, i) => i + 1),
          pickDay
        );
      }
    };

    function pickYear(y) {
      hiddenYear.value = String(y);
      yearLabel.textContent = `${y}ë…„`;
      yearLabel.parentElement.classList.add("selected");
      document
        .querySelectorAll(".date-dropdown.open")
        .forEach((x) => x.classList.remove("open"));
      // ì›”/ì¼ ì˜ì¡´ì„± ì²˜ë¦¬
      if (hiddenMonth.value) {
        const dmax = daysIn(
          Number(hiddenYear.value),
          Number(hiddenMonth.value)
        );
        if (!hiddenDay.value || Number(hiddenDay.value) > dmax) {
          hiddenDay.value = "";
          dayLabel.textContent = "ì¼";
          dayLabel.parentElement.classList.remove("selected");
        }
        // day ë¦¬ìŠ¤íŠ¸ ê°±ì‹ ì€ ë‹¤ìŒ open ì‹œ ìë™
      }
    }
    function pickMonth(m) {
      hiddenMonth.value = String(m).padStart(2, "0");
      monthLabel.textContent = `${m}ì›”`;
      monthLabel.parentElement.classList.add("selected");
      document
        .querySelectorAll(".date-dropdown.open")
        .forEach((x) => x.classList.remove("open"));
      const y = Number(hiddenYear.value) || new Date().getFullYear();
      const dmax = daysIn(y, Number(m));
      if (!hiddenDay.value || Number(hiddenDay.value) > dmax) {
        hiddenDay.value = "";
        dayLabel.textContent = "ì¼";
        dayLabel.parentElement.classList.remove("selected");
      }
    }
    function pickDay(d) {
      hiddenDay.value = String(d).padStart(2, "0");
      dayLabel.textContent = `${d}ì¼`;
      dayLabel.parentElement.classList.add("selected");
      document
        .querySelectorAll(".date-dropdown.open")
        .forEach((x) => x.classList.remove("open"));
    }

    // í¼ ë°– í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener("click", (e) => {
      if (!form.contains(e.target)) {
        document
          .querySelectorAll(".date-dropdown.open")
          .forEach((x) => x.classList.remove("open"));
      }
    });
  }

  // --- ì„±ë³„ ë²„íŠ¼ â†’ hidden(gender) ë™ê¸°í™” ---
  function initGenderButtons(form) {
    const box = form.querySelector("#genderButtons");
    const hidden = form.querySelector("#gender");
    if (!box || !hidden) return;

    box.addEventListener("click", (e) => {
      const btn = e.target.closest(".gender-btn");
      if (!btn) return;
      box
        .querySelectorAll(".gender-btn")
        .forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      hidden.value = btn.dataset.value || "";
    });
  }

  // --- ì œì¶œ ì²˜ë¦¬: /api/profile ì €ì¥ í›„ ë‹¤ìŒ í˜ì´ì§€ ì´ë™ ---
  async function handleSubmit(e) {
    e.preventDefault();
    const form = e.currentTarget;

    const nickname = form.querySelector('[name="nickname"]')?.value?.trim();
    const yy = form.querySelector("#birth_year")?.value;
    const mm = form.querySelector("#birth_month")?.value;
    const dd = form.querySelector("#birth_day")?.value;
    const gender = form.querySelector("#gender")?.value;

    if (!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if (!yy || !mm || !dd) return alert("ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!gender) return alert("ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

    // page1-info.htmlê³¼ ë™ì¼: ì„¸ì…˜ ì‹œì‘ ë° ì„œë²„ ë“±ë¡ â†’ í”„ë¡œí•„ ì €ì¥
    const fd = new FormData();
    fd.append("session_id", getSessionId());
    fd.append("nickname", nickname);
    fd.append("birth_date", `${yy}-${mm}-${dd}`);
    fd.append("gender", gender);

    const r = await fetch(`${API_BASE}/api/profile`, {
      method: "POST",
      body: fd,
    });

    // /api/profile POST ì„±ê³µ ì§í›„ì— ì¶”ê°€
    const profile = JSON.parse(localStorage.getItem("faceapp_profile") || "{}");
    profile.nickname = nickname;
    profile.birth_date = `${yy}-${mm}-${dd}`; // ì›ë¬¸ ê·¸ëŒ€ë¡œ ë³´ê´€
    profile.gender = gender;
    profile.timestamp_info = new Date().toISOString(); // ìˆ˜ì§‘ì‹œê°
    localStorage.setItem("faceapp_profile", JSON.stringify(profile));

    if (!r.ok) {
      const t = await r.text();
      console.error(t);
      return alert("ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }

    // ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™ (ê¸°ì¡´ íë¦„ê³¼ ë™ì¼)
    location.href = "signup_choice.html";
  }

  // --- í˜ì´ì§€ ë°”ì¸ë”© (signup_info ì „ìš©) ---
  document.addEventListener("DOMContentLoaded", () => {
    if (document.body.dataset.page !== "signup_info") return;

    // page1ì˜ UX ê·¸ëŒ€ë¡œ: ì§„ì… ì‹œ ìƒˆ ì„¸ì…˜ ì‹œì‘(ì„¸ì…˜ ë‹¨ìœ„ ëˆ„ì )  :contentReference[oaicite:2]{index=2}
    startNewSession();

    const form = document.querySelector("#infoForm");
    if (!form) return;
    initBirthDropdowns(form);
    initGenderButtons(form);

    form.addEventListener("submit", handleSubmit);
  });
})();

/* =========================================================
   [signup_choice ì´ì‹] page2-skin.htmlì˜ ìˆ˜ì§‘Â·ì „ì†¡ ë¡œì§
   - ì„¸ì…˜ ìƒì„±(/api/session) â†’ /api/skin ì €ì¥ â†’ ai_test_camera.html ì´ë™
   - ì„ íƒ UIëŠ” signup_choice.htmlì˜ .skin-btn.active ìƒíƒœë¥¼ ê·¸ëŒ€ë¡œ í™œìš©
   ========================================================= */
(function () {
  // í•„ìš”ì— ë”°ë¼ localhost:12345ë¥¼ í™˜ê²½ì— ë§ì¶° ë°”ê¾¸ì„¸ìš”.
  const API_BASE = (
    localStorage.getItem("API_BASE") || "https://face-capture-api.onrender.com"
  ).replace(/\/+$/, "");
  const NEXT_PAGE = "ai_test_camera.html"; // ì €ì¥ í›„ ì´ë™í•  í˜ì´ì§€

  // --- page2-skin.htmlê³¼ ë™ì¼í•œ ì„¸ì…˜ ë°œê¸‰/ë“±ë¡ íë¦„ ---  :contentReference[oaicite:5]{index=5}
  function getSessionId() {
    let sid = localStorage.getItem("faceapp_session");
    if (!sid) {
      sid =
        typeof crypto !== "undefined" && crypto.randomUUID
          ? crypto.randomUUID()
          : String(Date.now()) + Math.random().toString(16).slice(2);
      localStorage.setItem("faceapp_session", sid);
      // ì„œë²„ì—ë„ ë“±ë¡ (ì‹¤íŒ¨í•´ë„ ì§„í–‰)
      const fd = new FormData();
      fd.append("session_id", sid);
      fetch(`${API_BASE}/api/session`, { method: "POST", body: fd }).catch(
        () => {}
      );
    }
    return sid;
  }

  // DOM í—¬í¼
  const $ = (s, el = document) => el.querySelector(s);
  const $$ = (s, el = document) => [...el.querySelectorAll(s)];

  // í˜„ì¬ í˜ì´ì§€ê°€ signup_choiceê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ
  document.addEventListener("DOMContentLoaded", () => {
    const isChoice =
      document.body &&
      document.body.dataset &&
      document.body.dataset.page === "signup_choice";
    if (!isChoice) return;

    const startBtn =
      document.getElementById("start-button") ||
      document.getElementById("start");
    if (!startBtn) return;

    // í´ë¦­ ì‹œ: ì„ íƒê°’ ìˆ˜ì§‘ â†’ ì„œë²„ë¡œ ì „ì†¡ â†’ ë‹¤ìŒ í˜ì´ì§€
    // startBtn.addEventListener("click", async (e) => {
    //   // inline onClick(ì˜ˆ: validateSurvey())ì™€ í•¨ê»˜ ë™ì‘í•´ë„ ë¬¸ì œ ì—†ë„ë¡ ê¸°ë³¸ ë™ì‘ë§Œ ì°¨ë‹¨
    //   e.preventDefault();

    //   try {
    //     // 1) ì„ íƒê°’ ì½ê¸° (UI í´ë˜ìŠ¤/êµ¬ì¡°ëŠ” signup_choice.html ê²ƒì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©)  :contentReference[oaicite:6]{index=6}
    //     const typeBtn = $(".skin-type-section .skin-btn.active");
    //     const skinType = typeBtn ? typeBtn.textContent.trim() : null;

    //     const concernBtns = $$(".skin-concern-section .skin-btn.active");
    //     const concerns = concernBtns.map((b) => b.textContent.trim());

    //     const conditionBtns = $$(".skin-condition-section .skin-btn.active");
    //     const conditions = conditionBtns.map((b) => b.textContent.trim());

    //     if (!skinType) {
    //       alert("í”¼ë¶€ íƒ€ì…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    //       return;
    //     }

    //     // 2) ë¡œì»¬ì—ë„ ìºì‹œ (page2-skin.htmlê³¼ ë™ì¼ ì»¨ë²¤ì…˜ ì‚¬ìš©: faceapp_profile)  :contentReference[oaicite:7]{index=7}
    //     const profile = JSON.parse(
    //       localStorage.getItem("faceapp_profile") || "{}"
    //     );
    //     profile.skinType = skinType;
    //     profile.concerns = concerns;
    //     profile.conditions = conditions;
    //     localStorage.setItem("faceapp_profile", JSON.stringify(profile));

    //     // 3) ì„œë²„ ì €ì¥ (page2-skin.htmlê³¼ ë™ì¼: FormDataë¡œ /api/skin POST)  :contentReference[oaicite:8]{index=8}
    //     const fd = new FormData();
    //     fd.append("session_id", getSessionId());
    //     fd.append("skin_type", skinType);
    //     fd.append("concerns", JSON.stringify(concerns));
    //     fd.append("conditions", JSON.stringify(conditions));

    //     const resp = await fetch(`${API_BASE}/api/skin`, {
    //       method: "POST",
    //       body: fd,
    //     });
    //     if (!resp.ok) {
    //       const txt = await resp.text();
    //       console.error(txt);
    //       alert("í”¼ë¶€ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    //       return;
    //     }

    //     // 4) ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™ (ê¸°ì¡´ íë¦„ì— ë§ê²Œ ìˆ˜ì • ê°€ëŠ¥)
    //     location.href = NEXT_PAGE;
    //   } catch (err) {
    //     console.error(err);
    //     alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    //   }
    // });
  });
})();

// ===================== ê³µí†µ ì„¤ì • =====================
const API_BASE = (
  localStorage.getItem("API_BASE") || "https://face-capture-api.onrender.com"
).replace(/\/+$/, "");

// page1/page2ì™€ ë™ì¼: ì„¸ì…˜ ID ë¡œì»¬+ì„œë²„ ë“±ë¡  :contentReference[oaicite:9]{index=9}
function getSessionId() {
  let sid = localStorage.getItem("faceapp_session");
  if (!sid) {
    sid =
      crypto && crypto.randomUUID
        ? crypto.randomUUID()
        : String(Date.now()) + Math.random().toString(16).slice(2);
    localStorage.setItem("faceapp_session", sid);
    const fd = new FormData();
    fd.append("session_id", sid);
    fetch(`${API_BASE}/api/session`, { method: "POST", body: fd }).catch(
      () => {}
    );
  }
  return sid;
}

/***********************
 *  UTIL
 ***********************/
function q(sel) {
  return document.querySelector(sel);
}
function qa(sel) {
  return Array.from(document.querySelectorAll(sel));
}
function firstSel(selectors) {
  for (const s of selectors) {
    const el = typeof s === "string" ? q(s) : s;
    if (el) return el;
  }
  return null;
}

// ì„¸ì…˜ ìƒì„±/ë“±ë¡ (index/script_1ì™€ ë™ì¼ ì»¨ë²¤ì…˜)
function getSessionId() {
  let sid = localStorage.getItem("faceapp_session");
  if (!sid) {
    sid =
      crypto && crypto.randomUUID
        ? crypto.randomUUID()
        : String(Date.now()) + Math.random().toString(16).slice(2);
    localStorage.setItem("faceapp_session", sid);
    // ì„œë²„ì—ë„ ë“±ë¡ (ì‹¤íŒ¨í•´ë„ ì§„í–‰)
    const fd = new FormData();
    fd.append("session_id", sid);
    fetch(`${API_BASE}/api/session`, { method: "POST", body: fd }).catch(
      () => {}
    );
  }
  return sid;
}

// ì—…ë¡œë“œ (index.html + script_1.jsì˜ ì „ì†¡ ê·œê²© ê·¸ëŒ€ë¡œ)
// FormData: image, gender, age, session_id
async function uploadCapture(blob, gender, age) {
  const fd = new FormData();
  // fd.append("image", blob, `face_${Date.now()}.jpg`);
  fd.append("image", blob, `face_${Date.now()}.jpg`);
  // fd.append("file", blob, `face_${Date.now()}.jpg`);
  fd.append("gender", gender || "");
  // fd.append("age", age || "");
  // âœ… ë‚˜ì´ â†’ ë²„í‚· ê³„ì‚° (20/30/40/50/60, ë¯¸ë§Œì€ 10ìœ¼ë¡œ)
  const profile = JSON.parse(localStorage.getItem("faceapp_profile") || "{}");
  let ageNum = Number(age);
  if (!ageNum && profile.birth_date) {
    const by = new Date(profile.birth_date).getFullYear();
    ageNum = new Date().getFullYear() - by;
  }
  if (!ageNum) {
    const shootAge = Number(localStorage.getItem("shoot_age") || "");
    if (shootAge) ageNum = shootAge;
  }
  // ë²„í‚· ê·œì¹™
  let bucket = null;
  if (ageNum) {
    if (ageNum >= 60) bucket = 60;
    else if (ageNum >= 50) bucket = 50;
    else if (ageNum >= 40) bucket = 40;
    else if (ageNum >= 30) bucket = 30;
    else if (ageNum >= 20) bucket = 20;
    else bucket = 10; // 10ëŒ€ ì´í•˜
  }
  // if (bucket) fd.append("age_bucket", String(bucket));
  if (bucket) {
    fd.append("age_bucket", String(bucket)); // ì„œë²„ê°€ age_bucketì„ ê¸°ëŒ€í•˜ëŠ” ê²½ìš°
    fd.append("age", String(bucket)); // ì„œë²„ê°€ age(ì •ìˆ˜)ë¥¼ ê¸°ëŒ€í•˜ëŠ” ê²½ìš°
  }

  // ë™ì˜ ì—¬ë¶€ ì „ë‹¬(ë™ì˜ í˜ì´ì§€ì—ì„œ ì €ì¥í•´ë‘” ê°’ í™œìš©)
  // fd.append("consent", profile.consent ? "1" : "0");
  fd.append("consent", profile.consent ? "1" : "0");
  fd.append("session_id", getSessionId());

  const res = await fetch(`${API_BASE}/api/captures`, {
    method: "POST",
    body: fd,
  });
  // let data = null;
  // try {
  //   data = await res.json();
  // } catch (e) {}
  // if (!res.ok || (data && data.ok === false)) {
  //   throw new Error((data && data.error) || `Upload failed ${res.status}`);
  // }
  // // { ok, id, image_path, image_url } í˜•ì‹ ê¸°ëŒ€
  // return data;
  // if (!res.ok) {
  //   let msg = `Upload failed ${res.status}`;
  //   try {
  //     const t = await res.text();
  //     if (t) msg += `: ${t}`;
  //   } catch {}
  //   throw new Error(msg);
  // }
  if (!res.ok) {
    let msg = `Upload failed ${res.status}`;
    try {
      msg += `: ${(await res.text()) || ""}`;
    } catch {}
    throw new Error(msg);
  }
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) {
    try {
      const data = await res.json();
      return data && typeof data === "object" ? data : {};
    } catch {
      return {};
    }
  } else {
    const url = (await res.text()).trim();
    return url ? { image_url: url } : {};
  }
  // ì‘ë‹µì´ JSONì´ë©´ íŒŒì‹±, ì•„ë‹ˆë©´ textë¥¼ URLë¡œ ê°€ì •
  // const ct = res.headers.get("content-type") || "";
  // if (ct.includes("application/json")) {
  //   try {
  //     const data = await res.json();
  //     // í•­ìƒ ê°ì²´ ë°˜í™˜
  //     return typeof data === "object" && data !== null ? data : {};
  //   } catch {
  //     return {};
  //   }
  // } else {
  //   // ì„œë²„ê°€ URL ë¬¸ìì—´ë§Œ ëŒë ¤ì¤„ ë•Œ ëŒ€ì‘
  //   const url = (await res.text()).trim();
  //   return url ? { image_url: url } : {};
  // }
}

/***********************
 *  MAIN
 ***********************/
class CameraPageAdapter {
  constructor() {
    // ë‹¤ì–‘í•œ HTML ë³€í˜•ì„ ê³ ë ¤í•œ ì…€ë ‰í„° í›„ë³´ë“¤
    this.$video = firstSel([
      "#camera-preview",
      "video.camera-preview",
      "video",
    ]);
    this.$placeholder = firstSel([
      "#camera-placeholder",
      ".camera-placeholder",
    ]);
    this.$overlay = firstSel(["#face-overlay", ".face-overlay"]);
    this.$capture = firstSel([
      "#capture-button",
      "#capture-btn",
      ".capture-button",
      "button.capture",
    ]);
    this.$fileInput = firstSel(["#camera-input", "input[type=file]"]);
    this.$genderButtons = qa('[data-option="gender"]');
    this.$ageButtons = qa('[data-option="age"]');

    this.gender = null;
    this.age = null;
    this.stream = null;
    this.isCapturing = false;

    this.bind();
    this.initState();

    // âœ… ì¶”ê°€: signup_info.htmlì—ì„œ ì €ì¥í•œ birth_date â†’ age ê³„ì‚°
    const profile = JSON.parse(localStorage.getItem("faceapp_profile") || "{}");
    if (profile.birth_date && !this.age) {
      const birthYear = new Date(profile.birth_date).getFullYear();
      const nowYear = new Date().getFullYear();
      this.age = nowYear - birthYear;
      localStorage.setItem("shoot_age", this.age); // ë‚´ë¶€ ë¡œì§ í˜¸í™˜
    }
    if (profile.gender && !this.gender) {
      this.gender = profile.gender;
      localStorage.setItem("shoot_gender", profile.gender);
    }
    this.updateCaptureBtn();
  }

  initState() {
    // ê°€ëŠ¥í•˜ë©´ ì´ì „ ì„ íƒ ë³µì›
    const g = localStorage.getItem("shoot_gender");
    const a = localStorage.getItem("shoot_age");
    if (g) {
      this.gender = g;
      this.markSelected("gender", g);
    }
    if (a) {
      this.age = a;
      this.markSelected("age", a);
    }
    this.updateCaptureBtn();
  }

  bind() {
    // ì„±ë³„/ë‚˜ì´ ë²„íŠ¼ (data-option="gender"/"age" êµ¬ì¡° ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-option][data-value]");
      if (!btn) return;
      const opt = btn.dataset.option;
      const val = btn.dataset.value;

      // í•´ë‹¹ ê·¸ë£¹ì—ì„œ selected í´ë˜ìŠ¤ í† ê¸€
      const container = btn.parentElement;
      qa("[data-option]", container).forEach((b) =>
        b.classList.remove("selected")
      );
      btn.classList.add("selected");

      if (opt === "gender") {
        this.gender = val;
        localStorage.setItem("shoot_gender", val); // ì—…ë¡œë“œ ì‹œ í™œìš©
      } else if (opt === "age") {
        this.age = val;
        localStorage.setItem("shoot_age", val);
      }
      this.updateCaptureBtn();
    });

    // ì´¬ì˜ ë²„íŠ¼
    if (this.$capture) {
      this.$capture.addEventListener("click", () => this.startOrCapture());
    }

    // íŒŒì¼ ì—…ë¡œë“œ ëŒ€ì²´ ì…ë ¥(ìˆë‹¤ë©´)
    if (this.$fileInput) {
      this.$fileInput.addEventListener("change", (e) =>
        this.handleFileSelect(e)
      );
    }

    // í˜ì´ì§€ ìˆ¨ê¹€ ì‹œ ì¹´ë©”ë¼ ì •ì§€
    document.addEventListener("visibilitychange", () => {
      if (document.hidden && this.$video && this.$video.srcObject) {
        this.$video.srcObject.getTracks().forEach((t) => t.stop());
      }
    });
  }

  markSelected(kind, value) {
    const btns = qa(`[data-option="${kind}"]`);
    btns.forEach((b) => {
      if (b.dataset.value == value) b.classList.add("selected");
      else b.classList.remove("selected");
    });
  }

  updateCaptureBtn() {
    if (!this.$capture) return;
    const ok = !!(this.gender && this.age);
    this.$capture.disabled = !ok;
    if (!ok) this.$capture.textContent = "ì„±ë³„/ë‚˜ì´ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”";
    else
      this.$capture.textContent =
        this.$video && this.$video.srcObject ? "ì‚¬ì§„ ì´¬ì˜" : "ì´¬ì˜";
  }

  async startOrCapture() {
    // if (!this.gender || !this.age) {
    //   alert("ì„±ë³„ê³¼ ë‚˜ì´ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    //   return;
    // }
    // ì´ë¯¸ ì¹´ë©”ë¼ ì¼œì ¸ ìˆìœ¼ë©´ ì´¬ì˜
    if (this.$video && this.$video.srcObject) {
      this.capturePhoto();
      return;
    }
    // ì¹´ë©”ë¼ ì‹œì‘
    try {
      this.stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "user",
          width: { ideal: 640 },
          height: { ideal: 480 },
        },
        audio: false,
      });
      if (this.$video) {
        this.$video.srcObject = this.stream;
        this.$video.style.display = "block";
      }
      if (this.$placeholder) this.$placeholder.style.display = "none";
      if (this.$overlay) this.$overlay.classList.add("active");
      this.updateCaptureBtn();
    } catch (e) {
      console.error(e);
      alert("ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
    }
  }

  async ensureVideoReady(video) {
    // ë©”íƒ€ë°ì´í„°(í¬ê¸°) ì¤€ë¹„
    if (video.readyState < 1) {
      await new Promise((res) =>
        video.addEventListener("loadedmetadata", res, { once: true })
      );
    }
    // ì²« í”„ë ˆì„ ì¤€ë¹„
    if (video.readyState < 2) {
      await new Promise((res) =>
        video.addEventListener("loadeddata", res, { once: true })
      );
    }
    // í¬ê¸° í™•ì •(í˜¹ì‹œ 0ì¼ ë•Œ)
    if (!video.videoWidth || !video.videoHeight) {
      await new Promise((res) =>
        video.addEventListener("resize", res, { once: true })
      );
    }
    // í•œ í”„ë ˆì„ ë Œë” ë³´ì¥
    await new Promise((res) => requestAnimationFrame(() => res()));
  }

  async capturePhoto() {
    if (!this.$video) return alert("ë¹„ë””ì˜¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    if (this.isCapturing) return;
    this.isCapturing = true;
    if (this.$capture) {
      this.$capture.disabled = true;
      this.$capture.textContent = "ì´¬ì˜ ì¤‘...";
    }

    // const canvas = document.createElement("canvas");
    // canvas.width = this.$video.videoWidth;
    // canvas.height = this.$video.videoHeight;
    // const ctx = canvas.getContext("2d");

    // í•„ìš” ì‹œ ë¯¸ëŸ¬ ë³´ì •(ì›ë³¸ì´ ë¯¸ëŸ¬ ìƒíƒœë©´ ì£¼ì„ í•´ì œ)
    // ctx.translate(canvas.width, 0); ctx.scale(-1, 1);

    // ctx.drawImage(this.$video, 0, 0, canvas.width, canvas.height);
    // âœ… ë¹„ë””ì˜¤ í”„ë ˆì„ ì¤€ë¹„(ê²€ì€ ì´ë¯¸ì§€ ë°©ì§€)
    await this.ensureVideoReady(this.$video);
    await new Promise((r) => requestAnimationFrame(() => r()));

    const vw = this.$video.videoWidth || 640;
    const vh = this.$video.videoHeight || 480;
    if (!vw || !vh) {
      alert("ì¹´ë©”ë¼ í”„ë ˆì„ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      this.isCapturing = false;
      if (this.$capture) {
        this.$capture.disabled = false;
        this.$capture.textContent = "ì‚¬ì§„ ì´¬ì˜";
      }
      return;
    }

    // const vw = this.$video.videoWidth || 640;
    // const vh = this.$video.videoHeight || 480;
    const canvas = document.createElement("canvas");
    canvas.width = vw;
    canvas.height = vh;
    const ctx = canvas.getContext("2d");
    // í•„ìš” ì‹œ ë¯¸ëŸ¬ ë³´ì • (ì›ë³¸ì´ ì¢Œìš°ë°˜ì „ì´ë©´ ì£¼ì„ í•´ì œ)
    // ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
    ctx.drawImage(this.$video, 0, 0, vw, vh);

    canvas.toBlob(
      // async (blob) => {
      //   try {
      //     // const { image_url } = await uploadCapture(
      //     //   blob,
      //     //   this.gender,
      //     //   this.age
      //     // );
      //     const uploadRes = await uploadCapture(blob, this.gender, this.age);
      //     const image_url =
      //       uploadRes && uploadRes.image_url ? uploadRes.image_url : null;

      //     // í”„ë¦¬ë·° ìœ ì§€(ì´ë¯¸ì§€ë¡œ ëŒ€ì²´)
      //     if (this.$video) this.$video.style.display = "none";
      //     if (this.$overlay) this.$overlay.classList.remove("active");
      //     if (this.$placeholder) {
      //       this.$placeholder.innerHTML = "";
      //       this.$placeholder.style.display = "flex";
      //       const img = document.createElement("img");
      //       img.src = image_url;
      //       img.alt = "ì´¬ì˜ ì´ë¯¸ì§€";
      //       img.style.width = "100%";
      //       img.style.height = "100%";
      //       img.style.objectFit = "cover";
      //       this.$placeholder.appendChild(img);
      //     }

      //     // ì•ˆë‚´(ì„ íƒ)
      //     // alert("ì—…ë¡œë“œ ì™„ë£Œ!");
      //   } catch (err) {
      //     console.error(err);
      //     alert("ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      //   } finally {
      //     this.isCapturing = false;
      //     if (this.$capture) {
      //       this.$capture.disabled = false;
      //       this.$capture.textContent = "ì‚¬ì§„ ì´¬ì˜";
      //     }
      //     // ìŠ¤íŠ¸ë¦¼ì„ ë°”ë¡œ ë„ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
      //     // if (this.stream) this.stream.getTracks().forEach(t => t.stop());
      //   }
      // },
      // async (blob) => {
      //   // âœ… ì„œë²„ URLì´ ë¹„ì–´ë„ ê²°ê³¼ í˜ì´ì§€ì— ë„ìš¸ ìˆ˜ ìˆë„ë¡ base64ë¥¼ ë¨¼ì € í™•ë³´
      //   const base64 = canvas.toDataURL("image/jpeg", 0.85);
      //   try {
      //     const uploadRes = await uploadCapture(blob, this.gender, this.age);
      //     const image_url =
      //       uploadRes && uploadRes.image_url ? uploadRes.image_url : null;

      //     // âœ… ê²°ê³¼ í˜ì´ì§€ì—ì„œ ì“¸ ê°’ ì €ì¥
      //     if (image_url) localStorage.setItem("last_capture_url", image_url);
      //     localStorage.setItem("capturedFaceImage", base64);

      //     // í”„ë¦¬ë·° ìœ ì§€(ì´ë¯¸ì§€ë¡œ ëŒ€ì²´) â€” URL ìš°ì„ , ì—†ìœ¼ë©´ base64
      //     if (this.$video) this.$video.style.display = "none";
      //     if (this.$overlay) this.$overlay.classList.remove("active");
      //     if (this.$placeholder) {
      //       this.$placeholder.innerHTML = "";
      //       this.$placeholder.style.display = "flex";
      //       const img = document.createElement("img");
      //       img.src = image_url || base64; // âœ… ì•ˆì „í•œ ëŒ€ì²´
      //       img.alt = "ì´¬ì˜ ì´ë¯¸ì§€";
      //       img.style.width = "100%";
      //       img.style.height = "100%";
      //       img.style.objectFit = "cover";
      //       this.$placeholder.appendChild(img);
      //     }

      //     // âœ… ë°”ë¡œ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
      //     location.href = "ai_test_result.html";
      //   } catch (err) {
      //     console.error(err);
      //     alert("ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      //   } finally {
      //     this.isCapturing = false;
      //     if (this.$capture) {
      //       this.$capture.disabled = false;
      //       this.$capture.textContent = "ì‚¬ì§„ ì´¬ì˜";
      //     }
      //     // ìŠ¤íŠ¸ë¦¼ì„ ë°”ë¡œ ë„ë ¤ë©´ ì£¼ì„ í•´ì œ
      //     // if (this.stream) this.stream.getTracks().forEach(t => t.stop());
      //   }
      // },
      async (blob) => {
        const base64 = canvas.toDataURL("image/jpeg", 0.85);
        try {
          const uploadRes = await uploadCapture(blob, this.gender);
          const image_url =
            uploadRes && uploadRes.image_url ? uploadRes.image_url : null;

          if (image_url) localStorage.setItem("last_capture_url", image_url);
          localStorage.setItem("capturedFaceImage", base64);

          // í”„ë¦¬ë·° ì˜ì—­ ì—…ë°ì´íŠ¸(ìˆë‹¤ë©´)
          if (this.$video) this.$video.style.display = "none";
          if (this.$overlay) this.$overlay.classList.remove("active");
          if (this.$placeholder) {
            this.$placeholder.innerHTML = "";
            this.$placeholder.style.display = "flex";
            const img = document.createElement("img");
            img.src = image_url || base64;
            img.alt = "ì´¬ì˜ ì´ë¯¸ì§€";
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "cover";
            this.$placeholder.appendChild(img);
          }

          // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
          location.href = "ai_test_result.html";
        } catch (err) {
          console.error(err);
          alert("ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        } finally {
          this.isCapturing = false;
          if (this.$capture) {
            this.$capture.disabled = false;
            this.$capture.textContent = "ì‚¬ì§„ ì´¬ì˜";
          }
        }
      },
      "image/jpeg",
      0.85
    );
  }

  handleFileSelect(e) {
    const file = e.target.files && e.target.files[0];
    if (!file || !this.$video || !this.$placeholder) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      // ë¯¸ë¦¬ë³´ê¸° ëŒ€ì²´ (íŒŒì¼ í”„ë¦¬ë·° ëª¨ë“œ)
      this.$video.style.display = "none";
      this.$placeholder.innerHTML = "";
      this.$placeholder.style.display = "flex";
      const img = document.createElement("img");
      img.src = ev.target.result;
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.objectFit = "cover";
      this.$placeholder.appendChild(img);
    };
    reader.readAsDataURL(file);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  // new CameraPageAdapter(); // í˜ì´ì§€ êµ¬ë™
  if (window.__cameraBooted) return; // âœ… ì „ì—­ ê°€ë“œ
  window.__cameraBooted = true;
  getSessionId(); // ì„¸ì…˜ ë³´ì¥
  const cam = new CameraPageAdapter();
  cam.startOrCapture();
});
